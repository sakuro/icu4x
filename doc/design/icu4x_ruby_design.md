# Ruby Intl Implementation Using ICU4X — Design Summary

---

## Conclusion

When implementing **Intl-equivalent functionality (DateTimeFormat / NumberFormat / PluralRules)** in Ruby using ICU4X, the following design is most practical and extensible:

- All APIs are provided in a **single `icu4x` gem**
- **Native (Rust) implementation is bundled in the same gem**
- **DataProvider as the core abstraction**, separating code from data supply
- Calendar support is **minimally required for DateTimeFormat (initially Gregorian only)**

---

## Overall Architecture

```
Ruby API (Public)
 ├─ Locale / Options / Error
 ├─ DateTimeFormat
 ├─ NumberFormat
 ├─ PluralRules
 └─ DataProvider (abstraction)

Native (Rust, ICU4X)
 ├─ locale / provider / error
 ├─ datetime
 ├─ number
 └─ plurals

Data (CLDR-derived)
 ├─ blob (generated by users/developers)
 └─ fs (future)
```

---

## 1. Target Scope

### Initial Implementation Targets

- DateTimeFormat
- NumberFormat
- PluralRules (cardinal / ordinal)

### Approach

- Use ICU4X (ICU4C is not adopted)
- Relationship with JavaScript Intl is **conceptual correspondence only**
- Prioritize clarity as a Ruby API over full compatibility

---

## 2. Gem Structure

### Module Organization

All classes are organized under the `ICU4X` module:

```ruby
ICU4X
├─ Locale              # BCP 47 locale identifier
├─ DataProvider        # Blob data loading
├─ LocaleFallbackProvider  # Locale fallback support
├─ DataGenerator       # Data generation API
├─ DateTimeFormat      # Date/time formatting (future)
├─ NumberFormat        # Number formatting (future)
├─ PluralRules         # Plural rules (future)
└─ Error               # Error class hierarchy
   ├─ LocaleError
   ├─ DataError
   └─ DataGeneratorError
```

---

## 3. Directory Structure

```
icu4x/
├─ lib/
│  ├─ icu4x.rb              # Main entry point
│  └─ icu4x/
│     └─ version.rb         # Version constant
├─ ext/
│  └─ icu4x/
│     ├─ Cargo.toml
│     ├─ extconf.rb
│     └─ src/
│        ├─ lib.rs
│        ├─ locale.rs
│        ├─ data_provider.rs
│        ├─ locale_fallback_provider.rs
│        └─ data_generator.rs
├─ sig/
│  └─ icu4x.rbs             # RBS type definitions
├─ spec/
│  ├─ icu4x/
│  │  ├─ locale_spec.rb
│  │  ├─ data_provider_spec.rb
│  │  ├─ data_generator_spec.rb
│  │  └─ locale_fallback_provider_spec.rb
│  └─ fixtures/
│     └─ test.blob          # Test data (generated)
├─ doc/
│  └─ design/               # Design documents
├─ Cargo.toml               # Rust workspace
├─ icu4x.gemspec
├─ Gemfile
├─ Rakefile
└─ README.md
```

---

## 4. Handling Native (Rust) Parts

### Approach

- **Bundled in the same gem**
- Rust extensions placed under `ext/icu4x/`
- Clear separation of responsibilities between Ruby API and native

### Role Division

- Ruby Layer
  - API definition
  - Argument validation
  - Option normalization
  - Error formatting
- Rust Layer
  - ICU4X invocation
  - DataProvider management
  - Actual data retrieval and formatting

---

## 5. DataProvider Design

### 5.1 Role

- Abstracts **"where" and "in what format"** locale data required by ICU4X is supplied
- Formatters depend only on DataProvider

---

### 5.2 Structure (Conceptual)

```
DataKey        : What data (datetime / number / plurals, etc.)
DataRequest    : locale / calendar, etc.
DataResponse   : Actual data
```

---

### 5.3 Provider Types

| Type | Content | Initial |
|------|---------|---------|
| blob | Single file data (Postcard format) | ◎ |
| fs | Directory loading | Future |

**Note**: No data is bundled with the gem. For testing/development, generate data using `ICU4X::DataGenerator`.

---

### 5.4 Data Supply Method

**User-generated data approach** is adopted:

1. Users generate data using `ICU4X::DataGenerator` API
2. Place generated blob file in application
3. Load at runtime with `DataProvider.from_blob`

**Benefits**:
- Reduced gem size (no need to bundle all locales)
- Users can select only needed locales
- Optimized data set for each application

---

### 5.5 Ruby API Example

```ruby
# Load blob file
provider = ICU4X::DataProvider.from_blob(Pathname.new("path/to/data.blob"))

dtf = ICU4X::DateTimeFormat.new(
  ICU4X::Locale.parse("ja-JP"),
  provider: provider,
  date_style: :long
)
```

**Note**: No implicit fallback. Provider must always be explicitly specified.

---

## 6. DateTimeFormat and Calendars

- Calendar is **required**
- Initial support is `gregory` only
- `calendar:` option is accepted for future expansion
- Completed on ICU4X side without depending on Ruby's `Time` / `Date`

---

## 7. Ruby API Usage Examples

```ruby
loc = ICU4X::Locale.parse("ja-JP")

dtf = ICU4X::DateTimeFormat.new(
  loc,
  time_zone: "Asia/Tokyo",
  date_style: :long,
  time_style: :short
)

dtf.format(Time.utc(2025, 12, 28, 9, 30))
# => "2025年12月28日 18:30"

nf = ICU4X::NumberFormat.new(
  loc,
  style: :currency,
  currency: "JPY"
)

nf.format(1_234_567)
# => "￥1,234,567"

pr = ICU4X::PluralRules.new(
  ICU4X::Locale.parse("en"),
  type: :cardinal
)

pr.select(1) # => :one
```

---

## 8. Design Decisions Summary

- DataProvider: **Fixed as core abstraction**
- Calendar: **Start with minimal support**
- Data: **Users generate blob, gem bundles only test data**
- DataGenerator: **Bundled in the gem (Ruby API)**

---

## Notes

- Float rounding and financial use cases require strict requirements and expert review
- Need to track ICU4X API changes
- Data bundle size directly affects gem size
- Native build verification needed on Windows / macOS / Linux

---

## 9. DataGenerator (Data Generation)

### 9.1 Overview

Data generation functionality is provided in two ways:

| Use Case | Method | Notes |
|----------|--------|-------|
| Gem development | Rust `icu4x-datagen` command | Rust required in dev environment |
| Gem users | Ruby API | No Rust required |

---

### 9.2 Interface for Gem Users

Binding `icu_datagen` crate to Ruby via Rust extension, provided as Ruby API.

```ruby
ICU4X::DataGenerator.export(
  locales: %w[ja en],
  markers: :all,              # or specific marker names
  format: :blob,
  output: Pathname.new("data/icu4x.blob")
)
```

**Note**: CLI is not provided (to avoid confusion with Rust version `icu4x-datagen`).

---

### 9.3 Data Generation for Gem Development

For gem development and testing, use Rust's `icu4x-datagen` command directly:

```bash
# Generate development/test data (covering all plural categories)
$ icu4x-datagen --locales en,ja,ru,ar --markers all --format blob --output spec/fixtures/test.blob
```

- No data is bundled with the gem
- Place test blob in `spec/fixtures/`
- Exclude blob files in `.gitignore`, generate on each CI run

---

### 9.4 Rust Dependencies

```toml
[dependencies]
magnus = "0.8"
icu_provider_source = "2.1"
icu_provider_export = "2.1"
icu_provider_blob = "2.1"
```

---

### 9.5 Development/Test Locales

Recommended locale set for comprehensive testing during development:

#### Recommended Locale Set

| Locale | Purpose |
|--------|---------|
| `en` | Basic functionality, English locale testing |
| `ja` | Japanese environment testing, non-Latin characters |
| `ru` | Plural rules testing (few / many) |
| `ar` | All plural categories coverage, RTL testing |

#### Plural Category Coverage

To test all 6 CLDR plural categories:

| Category | Test Locale |
|----------|-------------|
| `:zero` | `ar` (Arabic) |
| `:one` | `en`, `ru` |
| `:two` | `ar` |
| `:few` | `ru`, `ar` |
| `:many` | `ru`, `ar` |
| `:other` | All languages |

**Minimum set**: 3 locales `en`, `ru`, `ar` cover all categories.

#### Development Data Generation Examples

```ruby
# Development/test (all features)
ICU4X::DataGenerator.export(
  locales: %w[en ja ru ar],
  markers: :all,
  format: :blob,
  output: Pathname.new("spec/fixtures/dev_data.blob")
)

# Plurals test only (lightweight)
ICU4X::DataGenerator.export(
  locales: %w[en ru ar],
  markers: %w[PluralsCardinalV1 PluralsOrdinalV1],
  format: :blob,
  output: Pathname.new("spec/fixtures/plurals_test.blob")
)
```

---

## Confidence

**High**

This design is based on Ruby gem best practices and ICU4X design philosophy.
