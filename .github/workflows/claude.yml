# Claude Code Integration
#
# This workflow provides AI-assisted development capabilities:
# - Interactive: Responds to @claude mentions in issues and PR comments
# - Review: Automatically reviews new pull requests, or on-demand via label

name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, labeled]

jobs:
  claude-interactive:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    concurrency:
      group: claude-interactive-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  claude-review:
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' ||
       (github.event.action == 'labeled' && github.event.label.name == 'claude-review'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    concurrency:
      group: claude-review-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Review this pull request. Focus ONLY on the files and changes shown in the PR diff.
            Do not review or comment on other parts of the codebase.
            Keep your review concise and actionable.
      - name: Remove review label
        if: github.event.action == 'labeled'
        run: gh pr edit ${{ github.event.pull_request.number }} --remove-label claude-review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
